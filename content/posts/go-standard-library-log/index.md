+++
date = '2025-09-26T11:27:11+08:00'
lastmod = '2025-09-26T11:27:11+08:00'
draft = false
title = 'Goæ ‡å‡†åº“ log æºç ä¸åŸç†è§£æ'
slug = 'golang-std-lib-log-source-analysis'
description = 'å¯¹Go v1.25.1çš„logæ ‡å‡†åº“æºç è¿›è¡Œåˆ†æï¼Œæ¶µç›–æ ¸å¿ƒLoggerç±»å‹ã€æ—¥å¿—å‰ç¼€æ ‡å¿—ä½ã€æ ‡å‡†Loggerã€æ—¥å¿—è¾“å‡ºçš„å®Œæ•´æµç¨‹'
keywords = ["Go", "Golang", "æ ‡å‡†åº“", "log", "æ—¥å¿—", "æºç è§£æ", "Logger", "isDiscard", "calldepth"]
categories = ["Goæºç å­¦ä¹ "]
tags = ["Go", "log", "æºç è§£æ"]
+++

ğŸ“Œè¯´æ˜ï¼šæœ¬æ–‡åŸºäº Go v1.25.1 æºç è§£æï¼Œåç»­ç‰ˆæœ¬å¯èƒ½æœ‰æ‰€è°ƒæ•´

## ç®€ä»‹
log åŒ…æ˜¯æ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ä¸ªç®€å•çš„æ—¥å¿—å·¥å…·ï¼Œå¯ä»¥å°†ç¨‹åºè¿è¡Œä¸­äº§ç”Ÿçš„ä¿¡æ¯è¾“å‡ºåˆ°æ§åˆ¶å°æˆ–æ–‡ä»¶ç­‰ä½ç½®ï¼Œä¾¿äºè°ƒè¯•å’Œæ’æŸ¥é—®é¢˜ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰ç‚¹ï¼š
1. è¾“å‡ºæ—¥å¿—
  - é»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—ä¼šè¢«è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯ stderrï¼Œå¹¶å¸¦æœ‰æ—¶é—´æˆ³
  - æ¯æ¡æ—¥å¿—ç‹¬å ä¸€è¡Œï¼Œå¦‚æœæ—¥å¿—æ­£æ–‡ï¼ˆä¼ å…¥çš„å‚æ•°ï¼‰ç»“å°¾æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œé‚£ä¹ˆä¼šè‡ªåŠ¨åŠ ä¸Šæ¢è¡Œ
  ```go
	log.Print("Hello, World!")
	// 2025/09/20 22:55:51 Hello, World!
  ```
2. æä¾›ä¸‰ç±»æ—¥å¿—å‡½æ•°
  - `log.Print[f|ln]`ï¼šä»…è¾“å‡ºæ—¥å¿—
  - `log.Panic[f|ln]`ï¼šç­‰ä»·äºæ‰§è¡Œ `Print[f|ln]` åè§¦å‘ Panicï¼Œä¼šæ‰§è¡Œ `defer`
  - `log.Fatal[f|ln]`ï¼šç­‰ä»·äºæ‰§è¡Œ `Print[f|ln]` åè°ƒç”¨ `os.Exit(1)` ç›´æ¥é€€å‡ºè¿›ç¨‹ï¼Œä¸ä¼šæ‰§è¡Œ `defer`
3. æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºä½ç½®ä¸æ—¥å¿—å†…å®¹
  - `log.SetOutput`ï¼š æ§åˆ¶å°†æ—¥å¿—å†™å…¥ä½•ç§å®ç°äº† `io.Writer` æ¥å£çš„ç›®æ ‡
  - `log.SetFlags`ï¼š è®¾ç½®è‡ªåŠ¨ç”Ÿæˆçš„å‰ç¼€ï¼ˆæ—¶é—´æˆ³ã€æ–‡ä»¶è·¯å¾„ã€è¡Œå·ç­‰ï¼‰
  - `log.SetPrefix`ï¼š è®¾ç½®ç”¨æˆ·è‡ªå®šä¹‰çš„å‰ç¼€ï¼Œé»˜è®¤æ·»åŠ åœ¨æ¯æ¡æ—¥å¿—çš„å¤´éƒ¨ï¼š
  ```go
	log.SetPrefix("LOG: ")
	log.Printf("Hello, World!")
	// LOG: 2025/09/20 23:50:11 Hello, World!
  ```

## æ—¥å¿—å‰ç¼€é…ç½®
### SetFlags ä¸æ ‡å¿—ä½
`log` åŒ…å®šä¹‰äº†ä¸€ç»„æ ‡å¿—ä½ï¼Œç”¨äºæ§åˆ¶è‡ªåŠ¨ç”Ÿæˆçš„å‰ç¼€ï¼Œå¤šä¸ªæ ‡å¿—å¯ä»¥ç”¨æŒ‰ä½æˆ–è¿ç®—è¿›è¡Œç»„åˆï¼š
| æ ‡å¿—ä½ | æè¿° | ç¤ºä¾‹ |
|---|---|---|
| Ldate | æœ¬åœ°æ—¥æœŸ | 2009/01/23 |
| Ltime | æœ¬åœ°æ—¶é—´ | 01:23:23 |
| Lmicroseconds | å¾®ç§’ | 01:23:23.123456 |
| Llongfile | å®Œæ•´æ–‡ä»¶è·¯å¾„ä¸è¡Œå· | /a/b/c/d.go:23 |
| Lshortfile | æ–‡ä»¶åä¸è¡Œå·, è¦†ç›– Llongfile | d.go:23 |
| LUTC | ä½¿ç”¨ UTC æ—¶é—´è€Œä¸æ˜¯æœ¬åœ°æ—¶é—´ | - |
| Lmsgprefix | æ§åˆ¶ç”¨æˆ·è‡ªå®šä¹‰å‰ç¼€çš„ä½ç½® | - |
| LstdFlags | é»˜è®¤æ ‡å¿—, ç­‰ä»·äº Ldate \| Ltime | - |

### SetPrefix ä¸ Lmsgprefix
å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œ`log.SetPrefix` ç”¨äºè®¾ç½®ç”¨æˆ·è‡ªå®šä¹‰çš„æ—¥å¿—å‰ç¼€æ–‡æœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‰ç¼€ä¼šè¢«æ·»åŠ åœ¨æ•´æ¡æ—¥å¿—çš„å¤´éƒ¨ï¼Œå³æ—¥å¿—çš„é¡ºåºä¸ºï¼šç”¨æˆ·è‡ªå®šä¹‰å‰ç¼€ -> Flags ç”Ÿæˆçš„å‰ç¼€ -> æ—¥å¿—æ­£æ–‡ã€‚

å¦‚æœè®¾ç½®äº† `Lmsgprefix` æ ‡å¿—ä½ï¼Œé‚£ä¹ˆæ—¥å¿—é¡ºåºä¼šå˜ä¸ºï¼šFlags ç”Ÿæˆçš„å‰ç¼€ -> ç”¨æˆ·è‡ªå®šä¹‰å‰ç¼€ -> æ—¥å¿—æ­£æ–‡ã€‚


## Logger ç±»å‹ä¸æ ‡å‡† Logger
### Logger ç±»å‹å®šä¹‰
`Logger` æ˜¯ `log` åŒ…çš„æ ¸å¿ƒç»“æ„ï¼Œæ‰€æœ‰çš„æ—¥å¿—è¾“å‡ºå‡½æ•°éƒ½æ˜¯è¯¥ç±»å‹ä¸Šçš„æ–¹æ³•ï¼š
```go
type Logger struct {
    outMu sync.Mutex // ç¡®ä¿å¤šä¸ª goroutine å¹¶å‘å®‰å…¨åœ°è®¿é—® Writer
    out   io.Writer  // æ—¥å¿—è¾“å‡ºç›®æ ‡

    prefix    atomic.Pointer[string]  // ç”¨æˆ·è‡ªå®šä¹‰å‰ç¼€
    flag      atomic.Int32            // æ—¥å¿—å‰ç¼€ä¿¡æ¯æ ‡å¿—ä½
    isDiscard atomic.Bool             // æ—¥å¿—è¾“å‡ºç›®æ ‡æ˜¯å¦ä¸º io.Discard
}

func New(out io.Writer, prefix string, flag int) *Logger {
    l := new(Logger)
    l.SetOutput(out)
    l.SetPrefix(prefix)
    l.SetFlags(flag)
    return l
}
```

### isDiscard çš„ä½œç”¨
`io.Discard` å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªâ€œé»‘æ´ Writerâ€œï¼Œå®ƒæ¥æ”¶æ•°æ®åä»€ä¹ˆä¹Ÿä¸åšï¼Œå¹¶ä¸”æ°¸è¿œè¿”å›å†™å…¥æˆåŠŸï¼š
```go
package io

var Discard Writer = discard{}

type discard struct{}
func (discard) Write(p []byte) (int, error) {
    return len(p), nil
}
```

`Logger.isDiscard` å­—æ®µä¼šåœ¨ `SetOutput` å‡½æ•°ä¸­è¢«èµ‹äºˆå€¼ï¼Œè®°å½•æ—¥å¿—è¾“å‡ºç›®æ ‡æ˜¯å¦ä¸º `io.Discard`ï¼Œ
è‹¥ä¸º `true`ï¼Œåˆ™è¡¨ç¤ºæ—¥å¿—ä¸ä¼šè¢«å®é™…è¾“å‡ºï¼Œå› æ­¤åœ¨æ—¥å¿—è¾“å‡ºçš„æ ¸å¿ƒè·¯å¾„ä¸­å¯ä»¥å°½æ—©è¿”å›ï¼Œé¿å…åç»­çš„åŠ é”ã€æ„é€ å‰ç¼€ã€å®é™… I/O ç­‰å¼€é”€ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚
```go
func (l *Logger) SetOutput(w io.Writer) {
	l.outMu.Lock()
	defer l.outMu.Unlock()
	l.out = w
	l.isDiscard.Store(w == io.Discard)
}
```

ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`isDiscard` åªèƒ½é¿å…æ—¥å¿—è¾“å‡ºè·¯å¾„çš„åç»­å¼€é”€ï¼Œè€Œæ— æ³•é¿å…ä¼ å…¥å‚æ•°çš„è®¡ç®—å¼€é”€ï¼Œä¾‹å¦‚ä»£ç  `log.Print("Result:", cost())` ä¸­çš„ `cost()` å‡½æ•°ä»ç„¶ä¼šè¢«æ‰§è¡Œã€‚

### æ ‡å‡†Logger
é™¤äº†æ‰‹åŠ¨åˆå§‹åŒ– Logger ä¹‹å¤–ï¼Œ`log` åŒ…é¢„å®šä¹‰äº†ä¸€ä¸ªå…¨å±€çš„æ ‡å‡† Loggerï¼š
```go
var std = New(os.Stderr, "", LstdFlags)

// Default returns the standard logger used by the package-level output functions.
func Default() *Logger { return std }
```
æ ‡å‡† Logger `std` é»˜è®¤å°†æ—¥å¿—è¾“å‡ºåˆ° stderrï¼Œæ²¡æœ‰ç”¨æˆ·è‡ªå®šä¹‰å‰ç¼€ï¼Œå¹¶ä¸”è‡ªåŠ¨ä¸ºæ—¥å¿—ç”Ÿæˆæœ¬åœ°æ—¥æœŸä¸æ—¶é—´çš„å‰ç¼€ï¼Œ`log` åŒ…çº§åˆ«çš„æ—¥å¿—å‡½æ•°ï¼ˆå¦‚ `log.Print`ï¼‰æœ¬è´¨ä¸Šéƒ½æ˜¯è°ƒç”¨ `std` ä¸Šçš„æ–¹æ³•ï¼Œè¿™æ­ç¤ºäº†ä¸Šæ–‡ä¸­æè¿°çš„ `log` åŒ…çš„é»˜è®¤è¡Œä¸ºæ˜¯æ€ä¹ˆæ¥çš„ã€‚

æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ `log.Default()` å‡½æ•°è·å– `std`ï¼Œå› æ­¤è°ƒç”¨ `log.Print` ä¸è°ƒç”¨ `log.Default().Print` æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œå‰è€…å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§è¯­æ³•ç³–ã€‚

## æ—¥å¿—è¾“å‡ºæµç¨‹è§£æ
æ— è®ºæ˜¯è‡ªå®šä¹‰ Loggerï¼Œè¿˜æ˜¯æ ‡å‡† Loggerï¼Œè°ƒç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°åéƒ½ä¼šèµ°åˆ° `Logger.output` å‡½æ•°ä¸­ï¼Œå› æ­¤ä¸‹æ–‡ä»¥ `Logger.Print` å‡½æ•°ä¸ºä¾‹ï¼Œæè¿°æ—¥å¿—è¾“å‡ºçš„å®Œæ•´è·¯å¾„ï¼š
```go
// Print å‡½æ•°çš„å‚æ•°æ ¼å¼ä¸ fmt.Print ä¸€è‡´
func (l *Logger) Print(v ...any) {
	l.output(0, 2, func(b []byte) []byte {
		return fmt.Append(b, v...)
	})
}
```

### Logger.output æ ¸å¿ƒé€»è¾‘
`Logger.output` å‡½æ•°ç®€åŒ–åçš„å…³é”®æµç¨‹ä¸ºï¼š
```go
// pc å’Œ calldepth å‚æ•°éƒ½å¯ä»¥ç”¨äºè·å–æ—¥å¿—çš„æºæ–‡ä»¶è·¯å¾„ä¸è¡Œæ•°
// ç›®å‰åŒ…ä¸­çš„æ‰€æœ‰æ—¥å¿—è¾“å‡ºå‡½æ•°å‡å°† pc è®¾ä¸º 0
// appendOutput ç”¨äºå‘ç¼“å†²åŒºä¸­è¿½åŠ æ—¥å¿—æ­£æ–‡ï¼Œå› ä¸ºéœ€è¦å…ˆå†™å…¥æ—¥å¿—å‰ç¼€
func (l *Logger) output(pc uintptr, calldepth int, appendOutput func([]byte) []byte) error {
	// å¦‚æœæ—¥å¿—è¾“å‡ºç›®æ ‡æ˜¯ io.Discardï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼Œé¿å…åç»­å¼€é”€
	if l.isDiscard.Load() {
		return nil
	}

	now := time.Now()
	prefix := l.Prefix()
	flag := l.Flags()

	// æ ¹æ® pc æˆ– calldepth è°ƒç”¨ä¸åŒçš„å‡½æ•°è·å–æ—¥å¿—çš„æºæ–‡ä»¶è·¯å¾„ä¸è¡Œæ•°
	var file string
	var line int
	if flag&(Lshortfile|Llongfile) != 0 {
		if pc == 0 {
			var ok bool
			_, file, line, ok = runtime.Caller(calldepth)
			if !ok {
				file = "???"
				line = 0
			}
		} else {
			// pc å‚æ•°ç›®å‰å‡ä¸º 0ï¼Œè¿™é‡Œæš‚ä¸å±•å¼€
		}
	}

	// ä½¿ç”¨ sync.Pool ä¿å­˜å¯å¤ç”¨çš„ç¼“å†²åŒºï¼Œå‡å°é¢‘ç¹çš„å†…å­˜åˆ†é…ä¸å›æ”¶å‹åŠ›
	// è¿™é‡Œçš„ buf æ˜¯ *[]byte ç±»å‹ï¼Œç›®çš„æ˜¯é¿å…æ¯æ¬¡å–å‡ºç¼“å†²åŒºæ—¶çš„ slice header å¤åˆ¶
	buf := getBuffer()
	defer putBuffer(buf)
	// é¦–å…ˆæ„é€ æ—¥å¿—å‰ç¼€å†™å…¥ç¼“å†²åŒºï¼Œå†è¿½åŠ æ—¥å¿—æ­£æ–‡ï¼Œæœ€åè‡ªåŠ¨è¡¥æ¢è¡Œç¬¦
	// formatHeader å‡½æ•°çš„é€»è¾‘ç›¸å¯¹ç®€å•
	formatHeader(buf, now, prefix, flag, file, line)
	*buf = appendOutput(*buf)
	if len(*buf) == 0 || (*buf)[len(*buf)-1] != '\n' {
		*buf = append(*buf, '\n')
	}

	l.outMu.Lock()
	defer l.outMu.Unlock()
	_, err := l.out.Write(*buf)
	return err
}
```

<!-- æ ¹æ®å¯¹ `output` å‡½æ•°çš„æ¢³ç†ï¼Œè¿™é‡Œå¯ä»¥å¯¹ `isDiscard` å­—æ®µçš„é¿å…å¼€é”€çš„ä½œç”¨åšä¸€äº›è¡¥å……ï¼šæ—¥å¿—è¾“å‡ºå‡½æ•° `log.Print` ç­‰ä¼šé¦–å…ˆä½¿ç”¨ `fmt` åŒ…å¯¹è¾“å…¥å‚æ•°è¿›è¡Œæ ¼å¼åŒ–ï¼Œç„¶åæ‰ä¼šè°ƒç”¨ `output` å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`isDiscard` å­—æ®µåªèƒ½è·³è¿‡ `output` ä¸­çš„é€»è¾‘ï¼Œè€Œå¯¹äºè¾“å…¥å‚æ•°æ ¼å¼åŒ–ï¼Œæ¯”å¦‚è¯´å°†æŸä¸ª `cost()` å‡½æ•°çš„ç»“æœä½œä¸ºè¾“å…¥å‚æ•°ï¼Œè¿™éƒ¨åˆ†å¼€é”€æ˜¯æ— æ³•é¿å…çš„ã€‚ -->

### calldepth å‚æ•°
`calldepth` å‚æ•°è¡¨ç¤ºéœ€è¦å›æº¯å¤šå°‘å±‚å‡½æ•°è°ƒç”¨æ ˆæ¥è·å–æ—¥å¿—å®šä½çš„æ–‡ä»¶è·¯å¾„ä¸è¡Œå·ï¼Œå€¼ä¸º 0 æ—¶è¡¨ç¤ºå›æº¯åˆ° `runtime.Caller` çš„è°ƒç”¨æ–¹ï¼Œä»¥æ­¤ç±»æ¨ã€‚

ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œå‡è®¾æœ‰ä»¥ä¸‹ä»£ç ï¼š
```go
package main

import "log"

func test() {
	log.SetFlags(log.LstdFlags | log.Llongfile)
	log.Print("Hello") // Line 7
}

func main() {
	test()
}
```
å®ƒçš„å‡½æ•°è°ƒç”¨æ ˆä»æ ˆé¡¶å‘æ ˆåº•å¯ä»¥ç®€å•æè¿°ä¸ºï¼š
```text
runtime.Caller
  log.(*Logger).output
	log.Print
	  main.test
		main.main
		  runtime.main
```
é‚£ä¹ˆï¼š
- å¦‚æœ `calldepth=0`ï¼Œåˆ™è¾“å‡º `log.(*Logger).output` å‡½æ•°ä¸­è°ƒç”¨ `Caller` çš„ä½ç½®
- å¦‚æœ `calldepth=1`ï¼Œåˆ™è¾“å‡º `log.Print` å‡½æ•°ä¸­è°ƒç”¨ `output` çš„ä½ç½®
- å¦‚æœ `calldepth=2`ï¼Œåˆ™è¾“å‡ºç”¨æˆ·ç¨‹åºä¸­è°ƒç”¨ `log.Print` çš„ä½ç½®ï¼ˆå³ `main.go:7`ï¼‰ï¼Œè¿™é€šå¸¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„æ—¥å¿—å®šä½ï¼Œå› æ­¤ `log` åŒ…ä¸­çš„æ—¥å¿—è¾“å‡ºå‡½æ•°éƒ½ä¼šå°† `calldepth` è®¾ç½®ä¸º 2

å¦å¤–ï¼Œ`log` åŒ…è¿˜æä¾›äº†ä¸€ä¸ªæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ `calldepth` çš„ `Logger.Output` å‡½æ•°ï¼š
```go
func (l *Logger) Output(calldepth int, s string) error {
	return l.output(0, calldepth+1, func(b []byte) []byte { // +1 for this frame.
		return append(b, s...)
	})
}
```

## æ€»ç»“
æœ¬æ–‡åŸºäº Go v1.25.1 æºç è§£æäº† `log` æ ‡å‡†åº“çš„å®ç°åŸç†ï¼š
- `Logger` æ˜¯æ ¸å¿ƒç»“æ„ï¼Œå°è£…äº†æ—¥å¿—è¾“å‡ºå‰ç¼€ã€ç›®æ ‡ä¸å¹¶å‘å®‰å…¨æœºåˆ¶
- `Logger.isDiscard` å­—æ®µæä¾›äº†ä¸€å®šç¨‹åº¦ä¸Šçš„æ€§èƒ½ä¼˜åŒ–
- æ ‡å‡† Logger `std` æä¾›äº†é»˜è®¤çš„æ—¥å¿—è¡Œä¸ºï¼Œè®©ä½¿ç”¨æ›´åŠ ä¾¿æ·
- æ—¥å¿—æœ€ç»ˆé€šè¿‡ `Logger.output` å‡½æ•°å®Œæˆè¾“å‡ºï¼Œç»“åˆ `calldepth` å‚æ•°å®ç°äº†æ—¥å¿—å®šä½

æ€»è€Œè¨€ä¹‹ï¼Œ`log` æ ‡å‡†åº“é€‚ç”¨äºç®€å•ã€è½»é‡çš„æ—¥å¿—éœ€æ±‚ï¼Œä½†è‹¥éœ€è¦æ—¥å¿—åˆ†çº§ã€å¼‚æ­¥å†™å…¥ç­‰æ›´å¤æ‚çš„åŠŸèƒ½ï¼Œåˆ™å»ºè®®å¼•å…¥ç¬¬ä¸‰æ–¹æ—¥å¿—åº“ã€‚